version: "3.8"

services:
  # =====================================================
  # Backend Services with Traefik Labels
  # =====================================================
  account-api:
    build:
      context: ../tugas_akhir-eprocurement-backend-account
      dockerfile: Dockerfile
      args:
        - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
    container_name: eprocurement-account-api
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - ASPNETCORE_URLS=http://+:8001
      - AppSetting__DBConnectionString=${DB_CONNECTION_STRING}
      - AppSetting__Jwt__Key=${JWT_KEY}
      - AppSetting__Jwt__Issuer=${JWT_ISSUER}
      - AppSetting__Jwt__Audience1=${JWT_AUDIENCE_INVOICE}
      - AppSetting__Jwt__Audience2=${JWT_AUDIENCE_VENDOR}
      - AppSetting__Jwt__Audience3=${JWT_AUDIENCE_GENERAL}
      - AppSetting__Jwt__Audience4=${JWT_AUDIENCE_ACCOUNT}
      - AppSetting__BaseUrl__AccountApi=${ACCOUNT_API_URL}
      - AppSetting__BaseUrl__GeneralApi=${GENERAL_API_URL}
      - AppSetting__BaseUrl__InvoiceApi=${INVOICE_API_URL}
      - AppSetting__BaseUrl__VendorApi=${VENDOR_API_URL}
    networks:
      - eprocurement-network
      - traefik
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"

      # HTTP Router
      - "traefik.http.routers.account-api.rule=Host(`account-api.codeverse.id`)"
      - "traefik.http.routers.account-api.entrypoints=web"
      - "traefik.http.services.account-api.loadbalancer.server.port=8001"

      # HTTPS Router
      - "traefik.http.routers.account-api-secure.rule=Host(`account-api.codeverse.id`)"
      - "traefik.http.routers.account-api-secure.entrypoints=websecure"
      - "traefik.http.routers.account-api-secure.tls.certresolver=le"

      # Redirect HTTP to HTTPS
      - "traefik.http.middlewares.account-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.account-api.middlewares=account-redirect"

  general-api:
    build:
      context: ../tugas_akhir-eprocurement-backend-general
      dockerfile: Dockerfile
      args:
        - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
    container_name: eprocurement-general-api
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - ASPNETCORE_URLS=http://+:8002
      - AppSetting__DBConnectionString=${DB_CONNECTION_STRING}
      - AppSetting__Jwt__Key=${JWT_KEY}
      - AppSetting__Jwt__Issuer=${JWT_ISSUER}
      - AppSetting__Jwt__Audience1=${JWT_AUDIENCE_INVOICE}
      - AppSetting__Jwt__Audience2=${JWT_AUDIENCE_VENDOR}
      - AppSetting__Jwt__Audience3=${JWT_AUDIENCE_GENERAL}
      - AppSetting__Jwt__Audience4=${JWT_AUDIENCE_ACCOUNT}
      - AppSetting__BaseUrl__AccountApi=${ACCOUNT_API_URL}
      - AppSetting__BaseUrl__GeneralApi=${GENERAL_API_URL}
      - AppSetting__BaseUrl__InvoiceApi=${INVOICE_API_URL}
      - AppSetting__BaseUrl__VendorApi=${VENDOR_API_URL}
    networks:
      - eprocurement-network
      - traefik
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"

      # HTTP Router
      - "traefik.http.routers.general-api.rule=Host(`api.codeverse.id`)"
      - "traefik.http.routers.general-api.entrypoints=web"
      - "traefik.http.services.general-api.loadbalancer.server.port=8002"

      # HTTPS Router
      - "traefik.http.routers.general-api-secure.rule=Host(`api.codeverse.id`)"
      - "traefik.http.routers.general-api-secure.entrypoints=websecure"
      - "traefik.http.routers.general-api-secure.tls.certresolver=le"

      # Redirect HTTP to HTTPS
      - "traefik.http.middlewares.general-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.general-api.middlewares=general-redirect"

  invoice-api:
    build:
      context: ../tugas_akhir-eprocurement-backend-invoice
      dockerfile: Dockerfile
      args:
        - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
    container_name: eprocurement-invoice-api
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - ASPNETCORE_URLS=http://+:8003
      - AppSetting__DBConnectionString=${DB_CONNECTION_STRING}
      - AppSetting__Jwt__Key=${JWT_KEY}
      - AppSetting__Jwt__Issuer=${JWT_ISSUER}
      - AppSetting__Jwt__Audience1=${JWT_AUDIENCE_INVOICE}
      - AppSetting__Jwt__Audience2=${JWT_AUDIENCE_VENDOR}
      - AppSetting__Jwt__Audience3=${JWT_AUDIENCE_GENERAL}
      - AppSetting__Jwt__Audience4=${JWT_AUDIENCE_ACCOUNT}
      - AppSetting__BaseUrl__AccountApi=${ACCOUNT_API_URL}
      - AppSetting__BaseUrl__GeneralApi=${GENERAL_API_URL}
      - AppSetting__BaseUrl__InvoiceApi=${INVOICE_API_URL}
      - AppSetting__BaseUrl__VendorApi=${VENDOR_API_URL}
    networks:
      - eprocurement-network
      - traefik
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"

      # HTTP Router
      - "traefik.http.routers.invoice-api.rule=Host(`invoice-api.codeverse.id`)"
      - "traefik.http.routers.invoice-api.entrypoints=web"
      - "traefik.http.services.invoice-api.loadbalancer.server.port=8003"

      # HTTPS Router
      - "traefik.http.routers.invoice-api-secure.rule=Host(`invoice-api.codeverse.id`)"
      - "traefik.http.routers.invoice-api-secure.entrypoints=websecure"
      - "traefik.http.routers.invoice-api-secure.tls.certresolver=le"

      # Redirect HTTP to HTTPS
      - "traefik.http.middlewares.invoice-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.invoice-api.middlewares=invoice-redirect"

  vendor-api:
    build:
      context: ../tugas_akhir-eprocurement-backend-vendor
      dockerfile: Dockerfile
      args:
        - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
    container_name: eprocurement-vendor-api
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - ASPNETCORE_URLS=http://+:8004
      - AppSetting__DBConnectionString=${DB_CONNECTION_STRING}
      - AppSetting__Jwt__Key=${JWT_KEY}
      - AppSetting__Jwt__Issuer=${JWT_ISSUER}
      - AppSetting__Jwt__Audience1=${JWT_AUDIENCE_INVOICE}
      - AppSetting__Jwt__Audience2=${JWT_AUDIENCE_VENDOR}
      - AppSetting__Jwt__Audience3=${JWT_AUDIENCE_GENERAL}
      - AppSetting__Jwt__Audience4=${JWT_AUDIENCE_ACCOUNT}
      - AppSetting__BaseUrl__AccountApi=${ACCOUNT_API_URL}
      - AppSetting__BaseUrl__GeneralApi=${GENERAL_API_URL}
      - AppSetting__BaseUrl__InvoiceApi=${INVOICE_API_URL}
      - AppSetting__BaseUrl__VendorApi=${VENDOR_API_URL}
    networks:
      - eprocurement-network
      - traefik
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"

      # HTTP Router
      - "traefik.http.routers.vendor-api.rule=Host(`vendor-api.codeverse.id`)"
      - "traefik.http.routers.vendor-api.entrypoints=web"
      - "traefik.http.services.vendor-api.loadbalancer.server.port=8004"

      # HTTPS Router
      - "traefik.http.routers.vendor-api-secure.rule=Host(`vendor-api.codeverse.id`)"
      - "traefik.http.routers.vendor-api-secure.entrypoints=websecure"
      - "traefik.http.routers.vendor-api-secure.tls.certresolver=le"

      # Redirect HTTP to HTTPS
      - "traefik.http.middlewares.vendor-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.vendor-api.middlewares=vendor-redirect"

  # =====================================================
  # Frontend - Vue.js Application
  # =====================================================
  frontend:
    build:
      context: ../tugas_akhir-eprocurement-frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=${VITE_API_BASE_URL}
    container_name: eprocurement-frontend
    environment:
      - NODE_ENV=production
    networks:
      - eprocurement-network
      - traefik
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"

      # HTTP Router
      - "traefik.http.routers.frontend.rule=Host(`evox.codeverse.id`)"
      - "traefik.http.routers.frontend.entrypoints=web"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"

      # HTTPS Router
      - "traefik.http.routers.frontend-secure.rule=Host(`evox.codeverse.id`)"
      - "traefik.http.routers.frontend-secure.entrypoints=websecure"
      - "traefik.http.routers.frontend-secure.tls.certresolver=le"

      # Redirect HTTP to HTTPS
      - "traefik.http.middlewares.frontend-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.frontend.middlewares=frontend-redirect"

# =====================================================
# Networks
# =====================================================
networks:
  eprocurement-network:
    driver: bridge
    name: eprocurement-network
  traefik:
    external: true
    name: proxy
